name: Branch Protection

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  checks: read
  statuses: read

jobs:
  enforce-branch-protection:
    name: 🛡️ Enforce Branch Protection
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check required status checks
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const { owner, repo } = context.repo;
            const sha = pr.head.sha;
            
            console.log(`Checking PR #${pr.number} (${sha})`);
            
            // Required checks that must pass before merge
            const requiredChecks = [
              '🔍 Lint Code',
              '🛠️ Build',
              '✅ PR Ready to Merge'
            ];
            
            // Get all status checks and check runs
            const [statusesResponse, checkRunsResponse] = await Promise.all([
              github.rest.repos.listCommitStatusesForRef({ owner, repo, ref: sha }),
              github.rest.checks.listForRef({ owner, repo, ref: sha })
            ]);
            
            const statuses = statusesResponse.data;
            const checkRuns = checkRunsResponse.data.check_runs;
            
            // Check if all required checks are passing
            const failedChecks = requiredChecks.filter(checkName => {
              const status = statuses.find(s => s.context === checkName && s.state === 'success');
              const checkRun = checkRuns.find(c => c.name === checkName && c.conclusion === 'success');
              return !status && !checkRun;
            });
            
            if (failedChecks.length === 0) {
              console.log('✅ All required checks passed');
            } else {
              console.log(`❌ Failed checks: ${failedChecks.join(', ')}`);
              core.setFailed(`Required checks not passing: ${failedChecks.join(', ')}`);
            }

  merge-gate:
    name: 🚪 Merge Gate
    runs-on: ubuntu-latest
    needs: enforce-branch-protection
    if: github.event_name == 'pull_request'
    steps:
      - name: Gate check
        run: echo "Merge gate passed" 